apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: backend-dr
  namespace: default
spec:
  host: backend
  trafficPolicy:
    # 1. Load Balancing: Random is better than RoundRobin for spikes
    loadBalancer:
      simple: LEAST_CONN 
    
    # 2. Connection Pool (The "Bouncer")
    connectionPool:
      tcp:
        maxConnections: 100        # Don't let more than 100 TCP connections open
      http:
        http1MaxPendingRequests: 50 # Queue size: Only 50 people allowed in the waiting room
        maxRequestsPerConnection: 40
    
    # 3. Outlier Detection (The "Ejector Seat")
    outlierDetection:
      consecutive5xxErrors: 10      # If a pod fails 10 times in a row...
      interval: 10s                # ...check every 10s...
      baseEjectionTime: 30s        # ...and kick it out of the pool for 30s.
      maxEjectionPercent: 100      # You can kick ALL pods if they are all bad.